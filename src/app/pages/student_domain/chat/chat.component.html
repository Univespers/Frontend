<div class="container">
  <!-- Lista de conversas -->
  <div class="chat-list mat-elevation-z5">
    <!-- Input de busca -->
    <div class="search-input">
      <mat-form-field>
        <input
          matInput
          placeholder="Procurar usuário"
          [formControl]="searchControl"
          [matAutocomplete]="users"
        />
      </mat-form-field>

      <mat-autocomplete
        #users="matAutocomplete"
        [displayWith]="displayFn"
        (optionSelected)="onUserSelected($event.option.value)"
      >
        <mat-option *ngFor="let user of filteredUsers$ | async" [value]="user">
          {{ user.nome }}
        </mat-option>
      </mat-autocomplete>
    </div>

    <!-- Botão para abrir popup de grupo -->
    <div class="new-group-container">
      <button class="new-group-btn dark-button" (click)="openGroupPopup()">
        + Novo Grupo
      </button>
    </div>

    <!-- Filtros -->
    <div class="chat-filters">
      <button class="filter-btn"
              [class.active]="currentFilter==='all'"
              (click)="setFilter('all')">Todos</button>
      <button class="filter-btn"
              [class.active]="currentFilter==='unread'"
              (click)="setFilter('unread')">Não lidos</button>
      <button class="filter-btn"
              [class.active]="currentFilter==='group'"
              (click)="setFilter('group')">Grupos</button>
    </div>

    <div
      *ngFor="let conv of filteredConversations$ | async"
      (click)="openConversation(conv)"
      class="conversation-item"
      [class.selected]="selectedConversation?.id === conv.id"
    >
      <p><b>{{ getConversationTitle(conv) }}</b></p>
      <small>Última: {{ getLastMessage(conv) }}</small>
    </div>
  </div>

  <!-- Área de mensagens -->
  <div class="messages mat-elevation-z5">
    <div
      *ngFor="let msg of messages$ | async"
      class="message"
      [ngClass]="msg.senderId === 'uuid123' ? 'mine' : 'their'"
    >
      <strong>{{ getSenderName(msg.senderId) }}:</strong>
      <span>{{ msg.text }}</span>
    </div>

    <div *ngIf="selectedConversation" class="message-input">
      <textarea
        #newMsg
        [placeholder]="placeholderText"
        (keydown)="onMessageKeydown($event, newMsg)"
        rows="1"
        class="message-textarea"
      ></textarea>
      <button (click)="sendMessageFromTextarea(newMsg)">Enviar</button>
    </div>
  </div>
</div>
